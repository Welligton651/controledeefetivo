<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle de Efetivo - Corporate BI</title>
    
    <!-- Tailwind CSS (Via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        corp: { main: '#0f172a', accent: '#2563eb', bg: '#f1f5f9', surface: '#ffffff', text: '#334155', muted: '#64748b' }
                    },
                    fontFamily: { sans: ['"Segoe UI"', 'Roboto', 'sans-serif'] },
                    boxShadow: { 'bi': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)' },
                    animation: { 'fade-in-left': 'fadeInLeft 0.5s ease-out forwards', 'blob': 'blob 10s infinite' },
                    keyframes: {
                        fadeInLeft: { '0%': { opacity: '0', transform: 'translateX(-20px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
                        blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- Libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; color: #334155; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .header-mask { background: linear-gradient(90deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 58, 138, 0.85) 100%), url('https://i.ibb.co/Jw2vSszL/1767716945834.jpg'); background-size: cover; background-position: center; }
        .nav-item { border-left: 3px solid transparent; transition: all 0.3s; cursor: pointer; }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: #fff; padding-left: 1.75rem; }
        .nav-item.active { background-color: rgba(255,255,255,0.1); border-left-color: #3b82f6; color: #fff; font-weight: 600; background: linear-gradient(90deg, rgba(59, 130, 246, 0.15) 0%, transparent 100%); }
        .sidebar-animated-bg { background: linear-gradient(135deg, #0f172a, #1e1b4b, #172554, #0f172a); background-size: 400% 400%; animation: sidebarGradient 15s ease infinite; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        @keyframes sidebarGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .bi-table th { background-color: #f8fafc; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; position: sticky; top: 0; z-index: 20; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        .bi-table tr:hover { background-color: #e0f2fe; }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-slate-100">

    <!-- Mobile Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-slate-300 flex-col shadow-xl z-50 fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 md:relative md:flex transition-transform duration-300 ease-in-out overflow-hidden">
        <div class="sidebar-animated-bg"></div>
        <div class="absolute top-0 -left-4 w-72 h-72 bg-blue-600 rounded-full mix-blend-multiply filter blur-[64px] opacity-10 animate-blob z-0"></div>
        <div class="absolute top-0 -right-4 w-72 h-72 bg-indigo-600 rounded-full mix-blend-multiply filter blur-[64px] opacity-10 animate-blob animation-delay-2000 z-0"></div>

        <div class="h-16 flex items-center px-6 border-b border-slate-700/50 z-10 relative bg-slate-900/20 backdrop-blur-sm justify-between md:justify-start">
            <div class="flex items-center">
                <div class="h-8 w-auto flex items-center justify-center mr-3">
                    <img src="https://i.ibb.co/vC4smFdx/Capturar0202-removebg-preview.png" alt="Logo" class="h-full object-contain invert filter brightness-0">
                </div>
                <span class="font-bold text-white text-lg tracking-tight drop-shadow-md">Controle Efetivo</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-white hover:text-blue-400"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <nav class="flex-1 py-6 space-y-1 z-10 relative overflow-y-auto">
            <p class="px-6 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Relatórios</p>
            <div onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center px-6 py-3 text-sm">
                <i class="fa-solid fa-gauge-high w-6"></i><span class="ml-3">Visão Geral</span>
            </div>
            <div onclick="switchTab('list')" id="nav-list" class="nav-item w-full flex items-center px-6 py-3 text-sm">
                <i class="fa-solid fa-table-list w-6"></i><span class="ml-3">Base de Dados</span>
            </div>
            <p class="px-6 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6">Dados</p>
            <div onclick="switchTab('import')" id="nav-import" class="nav-item w-full flex items-center px-6 py-3 text-sm">
                <i class="fa-solid fa-cloud-arrow-up w-6"></i><span class="ml-3">Importação</span>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-700/50 bg-slate-900/30 backdrop-blur-sm z-10 relative">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center text-xs text-emerald-400 font-medium" id="firebase-status">
                    <span class="relative flex h-2 w-2 mr-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75" id="status-ping"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500" id="status-dot"></span>
                    </span>
                    <span id="status-text" class="text-yellow-400">Conectando...</span>
                </div>
                <i class="fa-solid fa-server text-slate-500 text-xs"></i>
            </div>
            <div class="flex justify-between items-center text-[10px] text-slate-400">
                <span>v5.8 SearchModal</span><span class="bg-slate-800/50 px-1.5 py-0.5 rounded text-slate-400 border border-slate-700/50">Corp</span>
            </div>
        </div>
    </aside>

    <!-- Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-100 w-full relative">
        <header class="header-mask h-16 md:h-24 flex-shrink-0 shadow-md relative z-10">
            <div class="h-full w-full flex flex-col justify-center px-4 md:px-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="md:hidden text-white mr-4 p-2 rounded hover:bg-white/10"><i class="fa-solid fa-bars text-xl"></i></button>
                        <div>
                            <h1 id="page-title" class="text-lg md:text-2xl font-bold text-white drop-shadow-sm">Dashboard Executivo</h1>
                            <p class="text-blue-200 text-xs hidden sm:block" id="current-date">...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="resetData()" class="px-3 py-1.5 text-xs font-medium text-white bg-white/10 border border-white/20 rounded hover:bg-red-500/80 transition backdrop-blur-sm flex items-center">
                            <i class="fa-solid fa-trash-can sm:mr-2"></i> <span class="hidden sm:inline">Limpar</span>
                        </button>
                        <div class="flex items-center gap-3 pl-3 border-l border-white/20">
                            <div class="text-right hidden lg:block">
                                <p class="text-sm font-semibold text-white">Tamara Araújo</p>
                                <p class="text-xs text-blue-200">Gestão de Pessoal</p>
                            </div>
                            <div class="h-8 w-8 md:h-10 md:w-10 rounded-full border-2 border-white/30 overflow-hidden shadow-lg">
                                <img src="https://i.ibb.co/4q0BJ0k/tam.jpg" alt="Profile" class="h-full w-full object-cover">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-hidden p-2 md:p-6 bg-[#f8fafc] relative flex flex-col h-full">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="fade-in space-y-6 h-full overflow-y-auto pb-20 pr-1">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- KPI Cards -->
                    <div class="bg-white p-4 rounded-lg shadow-bi border border-slate-200 flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase flex items-center mb-1">
                                <img src="https://i.ibb.co/B2gBbYvf/Capturdfddfdfdfdfdr.png" class="w-4 h-4 mr-2 object-contain" style="filter: invert(68%) sepia(19%) saturate(1008%) hue-rotate(231deg) brightness(101%) contrast(94%);"> Total
                            </p>
                            <h3 class="text-3xl font-bold text-slate-800" id="stat-total">0</h3>
                        </div>
                        <div class="h-12 w-12 rounded bg-purple-50 flex items-center justify-center">
                            <img src="https://i.ibb.co/B2gBbYvf/Capturdfddfdfdfdfdr.png" class="w-7 h-7 object-contain" style="filter: invert(68%) sepia(19%) saturate(1008%) hue-rotate(231deg) brightness(101%) contrast(94%);">
                        </div>
                    </div>
                    
                    <!-- KPI 2: Licença (Modified with Details Button) -->
                    <div class="bg-white p-4 rounded-lg shadow-bi border border-slate-200 relative group transition-all hover:shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase flex items-center mb-1">
                                    <img src="https://i.ibb.co/xKPmc9pX/Captursssdsddsdsdsdar-removebg-preview.png" class="w-4 h-4 mr-2 object-contain" style="filter: invert(42%) sepia(93%) saturate(1352%) hue-rotate(330deg) brightness(110%) contrast(101%); opacity: 0.8;"> Licença
                                </p>
                                <h3 class="text-3xl font-bold text-slate-800" id="stat-licenca">0</h3>
                            </div>
                            <div class="h-12 w-12 rounded bg-red-50 flex items-center justify-center">
                                 <img src="https://i.ibb.co/xKPmc9pX/Captursssdsddsdsdsdar-removebg-preview.png" class="w-7 h-7 object-contain" style="filter: invert(42%) sepia(93%) saturate(1352%) hue-rotate(330deg) brightness(110%) contrast(101%);">
                            </div>
                        </div>
                        <button onclick="openLeaveModal()" class="mt-2 w-full text-xs text-red-500 hover:text-red-700 hover:bg-red-50 py-1.5 px-2 rounded transition flex items-center justify-center border border-red-100">
                            <i class="fa-solid fa-list-ul mr-2"></i> Ver Detalhes
                        </button>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-bi border border-slate-200 flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase flex items-center mb-1">
                                <img src="https://i.ibb.co/Myd9zLk2/Capturarccccc-removebg-preview.png" class="w-4 h-4 mr-2 object-contain" style="filter: invert(44%) sepia(87%) saturate(1476%) hue-rotate(167deg) brightness(95%) contrast(101%);"> Unidades
                            </p>
                            <h3 class="text-3xl font-bold text-slate-800" id="stat-locais">0</h3>
                        </div>
                        <div class="h-12 w-12 rounded bg-cyan-50 flex items-center justify-center">
                            <img src="https://i.ibb.co/Myd9zLk2/Capturarccccc-removebg-preview.png" class="w-7 h-7 object-contain" style="filter: invert(44%) sepia(87%) saturate(1476%) hue-rotate(167deg) brightness(95%) contrast(101%);">
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-bi border border-slate-200 flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase flex items-center mb-1">
                                <img src="https://i.ibb.co/f7rC31x/scsccscscscsc-removebg-preview.png" class="w-4 h-4 mr-2 object-contain" style="filter: invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);"> Cargos
                            </p>
                            <h3 class="text-3xl font-bold text-slate-800" id="stat-cargos">0</h3>
                        </div>
                        <div class="h-12 w-12 rounded bg-orange-50 flex items-center justify-center">
                             <img src="https://i.ibb.co/f7rC31x/scsccscscscsc-removebg-preview.png" class="w-7 h-7 object-contain" style="filter: invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-5 rounded-lg shadow-bi border border-slate-200 lg:col-span-1">
                        <h4 class="text-sm font-bold text-slate-700 uppercase mb-4 border-b pb-2">Distribuição</h4>
                        <div class="relative h-64 flex justify-center"><canvas id="chart-pie"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow-bi border border-slate-200 lg:col-span-2">
                        <h4 class="text-sm font-bold text-slate-700 uppercase mb-4 border-b pb-2">Top 10 Unidades</h4>
                        <div class="relative h-64"><canvas id="chart-units"></canvas></div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-lg shadow-bi border border-slate-200">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                        <h4 class="text-sm font-bold text-slate-700 uppercase">Ranking Top 15</h4>
                        <select id="chart-top15-filter" class="text-xs border rounded p-1"><option value="TOTAL">Total</option><option value="EFETIVO">Efetivos</option><option value="COMISSIONADO">Comissionados</option><option value="CONTRATADO">Contratos</option></select>
                    </div>
                    <div class="relative h-96"><canvas id="chart-top15"></canvas></div>
                </div>
            </div>

            <!-- LISTA -->
            <div id="view-list" class="hidden fade-in h-full flex flex-col">
                <div class="bg-white rounded-lg shadow-bi border border-slate-200 mb-2 p-3 shrink-0">
                    <div id="dynamic-stats-container" class="flex gap-3 mb-3 pb-2 border-b border-slate-100 overflow-x-auto whitespace-nowrap min-h-[80px]"></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                        <div class="md:col-span-1">
                             <div class="relative">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                <input type="text" id="search-input" placeholder="Pesquisar..." class="w-full pl-8 pr-2 py-1.5 bg-slate-50 border border-slate-300 rounded text-sm focus:outline-none focus:border-blue-500">
                             </div>
                        </div>
                        <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                            <select id="filter-lotacao" class="w-full p-1.5 bg-slate-50 border rounded text-xs"><option value="">Todas Unidades</option></select>
                            <select id="filter-cargo" class="w-full p-1.5 bg-slate-50 border rounded text-xs"><option value="">Todos Cargos</option></select>
                            <select id="filter-vinculo" class="w-full p-1.5 bg-slate-50 border rounded text-xs"><option value="">Todos Vínculos</option></select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-2">
                         <button onclick="exportToPrint()" class="bg-slate-700 text-white px-3 py-1 rounded text-[10px] hover:bg-slate-600"><i class="fa-solid fa-print mr-1"></i>PDF</button>
                         <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-3 py-1 rounded text-[10px] hover:bg-emerald-500"><i class="fa-solid fa-file-excel mr-1"></i>Excel</button>
                    </div>
                </div>

                <div class="bg-white border border-slate-200 rounded-lg shadow-bi flex-1 flex flex-col min-h-0 overflow-hidden">
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-left border-collapse bi-table min-w-[1000px]">
                            <thead class="sticky top-0 z-20 shadow-sm border-b border-slate-200 bg-white">
                                <tr>
                                    <th class="p-3 bg-slate-50 whitespace-nowrap">Nome</th>
                                    <th class="p-3 bg-slate-50 whitespace-nowrap">Lotação</th>
                                    <th class="p-3 bg-slate-50 whitespace-nowrap">Cargo / Função</th>
                                    <th class="p-3 bg-slate-50 whitespace-nowrap">Vínculo</th>
                                    <th class="p-3 bg-slate-50 whitespace-nowrap">Turno</th>
                                    <th class="p-3 bg-slate-50 whitespace-nowrap">Status</th>
                                    <th class="p-3 bg-slate-50 min-w-[150px]">Obs</th>
                                    <th class="p-3 bg-slate-50 w-24 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100 text-sm"></tbody>
                        </table>
                        <div id="empty-state" class="hidden flex flex-col items-center justify-center h-full text-slate-400 py-10">
                            <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
                            <p class="text-sm">Sem dados</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-2 text-xs text-center text-slate-500 border-t shrink-0">
                        <span id="showing-count">0</span> &bull; Total: <span id="db-count-badge">0</span>
                    </div>
                </div>
            </div>

            <!-- IMPORTAR -->
            <div id="view-import" class="hidden fade-in h-full flex items-center justify-center overflow-y-auto p-4">
                <div class="bg-white rounded-lg shadow-lg border border-slate-200 max-w-xl w-full">
                    <div class="p-6 border-b bg-slate-50"><h2 class="text-lg font-bold">Importação</h2></div>
                    <div class="p-8">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                            Modo Cumulativo: Dados novos são somados.
                        </div>
                        <label class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed rounded-lg cursor-pointer hover:bg-slate-50 transition">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                            <span class="text-sm text-slate-500 font-semibold">Clique para enviar</span>
                            <input id="file-upload" type="file" class="hidden" accept=".csv, .txt" />
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Editar -->
    <div id="edit-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 max-h-[90vh] flex flex-col" id="edit-modal-panel">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center rounded-t-lg shrink-0">
                <h3 class="font-bold text-slate-800">Editar</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="edit-id">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome</label><input type="text" id="edit-nome" class="w-full p-2 border rounded text-sm outline-none focus:border-blue-500"></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lotação</label><input type="text" id="edit-lotacao" class="w-full p-2 border rounded text-sm focus:border-blue-500"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cargo</label><input type="text" id="edit-cargo" class="w-full p-2 border rounded text-sm focus:border-blue-500"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Função</label><input type="text" id="edit-funcao" class="w-full p-2 border rounded text-sm focus:border-blue-500"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Vínculo</label><input type="text" id="edit-vinculo" class="w-full p-2 border rounded text-sm focus:border-blue-500"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Turno</label><input type="text" id="edit-turno" class="w-full p-2 border rounded text-sm focus:border-blue-500"></div>
                     <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Licença</label><input type="text" id="edit-licenca" class="w-full p-2 border rounded text-sm focus:border-blue-500"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Obs</label><textarea id="edit-observacao" rows="2" class="w-full p-2 border rounded text-sm focus:border-blue-500 resize-none"></textarea></div>
            </div>
            <div class="bg-slate-50 px-6 py-4 border-t flex justify-end gap-3 rounded-b-lg shrink-0">
                <button onclick="closeEditModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded">Cancelar</button>
                <button onclick="saveEdit()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded shadow-sm">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Leave Details Modal -->
    <div id="leave-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl transform scale-95 transition-transform duration-300 flex flex-col max-h-[85vh]">
            <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex flex-col sm:flex-row justify-between items-center rounded-t-lg shrink-0 gap-3">
                <h3 class="text-lg font-bold text-red-800 flex items-center">
                    <i class="fa-solid fa-notes-medical mr-2"></i> Servidores em Licença
                </h3>
                <div class="flex items-center gap-3 w-full sm:w-auto">
                    <!-- NEW SEARCH INPUT -->
                    <div class="relative w-full sm:w-64">
                         <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-red-400 text-xs"></i>
                         <input type="text" id="leave-search-input" placeholder="Filtrar por nome ou motivo..." class="w-full pl-8 pr-3 py-1.5 border border-red-200 rounded-full text-sm focus:outline-none focus:border-red-400 bg-white text-slate-700">
                    </div>
                    <button onclick="closeLeaveModal()" class="text-red-400 hover:text-red-600 p-1"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-slate-50" id="leave-list-container">
                <!-- List will be injected here -->
            </div>
            <div class="bg-white px-6 py-3 border-t flex justify-end rounded-b-lg shrink-0">
                <button onclick="closeLeaveModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded border border-slate-200">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 left-6 md:left-auto bg-slate-800 text-white px-6 py-4 rounded shadow-lg transform translate-y-40 transition-transform duration-300 z-[70] border-l-4 border-blue-500 flex items-center">
        <i class="fa-solid fa-circle-info mr-3 text-blue-400"></i><span id="toast-message" class="text-sm"></span>
    </div>

    <!-- SCRIPT PADRÃO (UI) -->
    <script>
        const personnelDataState = { data: [] };

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById(`nav-${tabId}`);
            if (btn) btn.classList.add('active');

            ['dashboard', 'list', 'import'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if(el) el.classList.add('hidden');
            });
            const view = document.getElementById(`view-${tabId}`);
            if(view) view.classList.remove('hidden');

            if (tabId === 'dashboard') {
                if(window.renderChartsFunc) setTimeout(window.renderChartsFunc, 100);
            }
            if (tabId === 'list') {
                if(window.applyFiltersFunc) window.applyFiltersFunc();
            }
            
            if(window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            
            if (forceClose) {
                 sidebar.classList.add('-translate-x-full');
                 backdrop.classList.add('hidden');
                 return;
            }

            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            const m = document.getElementById('toast-message');
            if(!t) return;
            m.innerText = msg;
            t.className = `fixed bottom-6 right-6 left-6 md:left-auto px-6 py-4 rounded shadow-lg transform transition-transform duration-300 z-[70] border-l-4 flex items-center text-white ${type === 'error' ? 'bg-slate-800 border-red-500' : 'bg-slate-800 border-blue-500'}`;
            t.classList.remove('translate-y-40');
            setTimeout(() => t.classList.add('translate-y-40'), 3000);
        }

        document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-PT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    </script>

    <!-- SCRIPT MÓDULO (Lógica + Dados) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const firebaseConfig = {
          apiKey: "AIzaSyByll4JEy9rOjgkOWT4DCsKdJjmNVUosVI",
          authDomain: "controle-de-estoque-65575.firebaseapp.com",
          projectId: "controle-de-estoque-65575",
          storageBucket: "controle-de-estoque-65575.firebasestorage.app",
          messagingSenderId: "1012381885255",
          appId: "1:1012381885255:web:61ec7900ba6c94370ee262",
          measurementId: "G-ZY0FJG1Q34"
        };

        let db, auth;
        let useFirebase = false;
        let currentData = [];
        let charts = {};

        // Helper Functions (DEFINED AT TOP to Fix ReferenceError)
        function getVinculoColor(v) {
            if (!v) return 'bg-gray-100 text-gray-600 border-gray-200';
            v = v.toUpperCase();
            if (v.includes('COMISSIONADO')) return 'bg-orange-50 text-orange-700 border-orange-200';
            if (v.includes('EFETIVO')) return 'bg-emerald-50 text-emerald-700 border-emerald-200';
            if (v.includes('CONTRATADO') || v.includes('CONTRATO')) return 'bg-blue-50 text-blue-700 border-blue-200';
            if (v.includes('ESTAGI')) return 'bg-indigo-50 text-indigo-700 border-indigo-200';
            if (v.includes('TEMPOR')) return 'bg-rose-50 text-rose-700 border-rose-200';
            return 'bg-slate-100 text-slate-700 border-slate-200';
        }

        function categorizeUnit(raw) {
            if (!raw) return "NÃO INFORMADO";
            let clean = raw.replace(/['"]/g, '').trim();
            const upper = clean.toUpperCase();
            if (upper.includes("ILPI")) return "ILPI";
            if (upper.includes("MSE") && upper.includes("NÚCLEO")) return "NÚCLEO MSE";
            const externas = ['SUMUS', 'SEMAD', 'SECULT', 'SEMGOV', 'SEMGOP', 'SEMED', 'SEMUS', 'SMTT', 'BLITZ', 'IPAM'];
            if (externas.some(ext => upper.includes(ext))) return "SECRETARIAS EXTERNAS";
            const sedeTerms = ['GABINETE', 'ASTEC', 'SEOF', 'CONTRATOS', 'SUPERINTEND', 'COORD.', 'COORDENAÇÃO', 'RECURSOS HUMANOS', 'RH', 'ADMINISTRAÇÃO', 'PATRIMONIO', 'SUPORTE', 'LOGÍSTICA', 'PROTOCOLO', 'ARQUIVO', 'ALMOXARIFADO', 'ASCOM', 'SAI', 'SGSUAS', 'SGBSTR', 'SPSB', 'SPSE', 'S.A', 'VIGILÂNCIA', 'GESTÃO DO TRABALHO', 'ASSEJUR', 'CMDI', 'CMAS', 'CMDCA', 'BENEFICIOS', 'CAD ÚNICO', 'CENTRAL', 'ABORDAGEM SOCIAL', 'PCDIF', 'SCFV', 'PAEFI', 'AEPETI', 'INFORMÁTICA'];
            if (sedeTerms.some(t => upper.includes(t))) return "SEDE SEMCAS";
            return clean;
        }

        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const result = [];
            if (lines.length === 0) return [];
            let separator = ';';
            if (lines[0] && lines[0].includes('\t')) separator = '\t';
            for (let line of lines) {
                line = line.trim();
                if (!line || line.toUpperCase().includes('LOTAÇÃO')) continue;
                let cols = line.split(separator).map(c => c.trim());
                if (/^(n[\s\.]*\d+|\d+)$/i.test(cols[0])) cols.shift();
                if (cols.length < 3) continue;
                const rawLotacao = cols[0] || '';
                const finalLotacao = categorizeUnit(rawLotacao);
                let obj = { lotacao: finalLotacao, nome: cols[1] || '', cargo: cols[3] || '', funcao: cols[4] || '', vinculo: cols[5] || '', turno: cols[6] || '', licenca: cols[7] || '', observacao: (cols[9] || '') };
                if (obj.nome) result.push(obj);
            }
            return result;
        }

        function openIDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('CorpViewDB', 1);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('personnel')) db.createObjectStore('personnel', { keyPath: 'id', autoIncrement: true });
                };
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = (e) => reject(e.target.error);
            });
        }

        // Expose functions
        window.resetData = resetData;
        window.exportToExcel = exportToExcel;
        window.exportToPrint = exportToPrint;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.saveEdit = saveEdit;
        window.confirmDelete = confirmDelete;
        window.renderChartsFunc = renderCharts;
        window.applyFiltersFunc = applyFilters;
        window.openLeaveModal = openLeaveModal;
        window.closeLeaveModal = closeLeaveModal;

        // Init Logic
        (async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                useFirebase = true;
                updateStatus(true);
            } catch (e) {
                console.warn("Firebase offline. Usando IndexedDB.", e);
                updateStatus(false);
            }
            await loadData();
            setupListeners();
        })();

        function updateStatus(online) {
            const txt = document.getElementById('status-text');
            const dot = document.getElementById('status-dot');
            const ping = document.getElementById('status-ping');
            if(online) {
                if(txt) { txt.innerText = "Conectado"; txt.className = "text-emerald-400"; }
                if(dot) dot.className = "relative inline-flex rounded-full h-2 w-2 bg-emerald-500";
                if(ping) ping.className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75";
            } else {
                if(txt) { txt.innerText = "Modo Local"; txt.className = "text-amber-400"; }
                if(dot) dot.className = "relative inline-flex rounded-full h-2 w-2 bg-amber-500";
                if(ping) ping.className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75";
            }
        }

        async function loadData() {
            currentData = [];
            if(useFirebase) {
                try {
                    const snap = await getDocs(collection(db, 'servidores'));
                    snap.forEach(d => currentData.push({ id: d.id, ...d.data() }));
                } catch(e) { useFirebase = false; return loadData(); }
            } else {
                try {
                    const idb = await openIDB();
                    currentData = await new Promise((resolve, reject) => {
                        const tx = idb.transaction('personnel', 'readonly');
                        const store = tx.objectStore('personnel');
                        const req = store.getAll();
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject(req.error);
                    });
                } catch(e) { console.error("IDB Error", e); }
            }
            populateFilters();
            applyFilters();
            renderCharts();
        }

        // --- Leave Modal Logic ---
        function renderLeaveList(filterText = '') {
            const container = document.getElementById('leave-list-container');
            const term = filterText.toLowerCase();

            // Filter
            const leaveList = currentData
                .filter(p => {
                    const hasLeave = p.licenca && p.licenca.trim().length > 2;
                    const matchesSearch = p.nome.toLowerCase().includes(term) || 
                                          p.licenca.toLowerCase().includes(term);
                    return hasLeave && matchesSearch;
                })
                .sort((a, b) => a.nome.localeCompare(b.nome));

            if (leaveList.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                        <i class="fa-solid fa-mug-hot text-4xl mb-3"></i>
                        <p>Nenhum servidor encontrado.</p>
                    </div>
                `;
            } else {
                container.innerHTML = leaveList.map(p => `
                    <div class="bg-white border-l-4 border-red-400 shadow-sm rounded-r p-4 mb-3 hover:bg-slate-50 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800">${p.nome}</h4>
                                <p class="text-sm text-slate-500 font-medium mt-1"><i class="fa-solid fa-hospital-user mr-1 text-red-400"></i> ${p.licenca}</p>
                            </div>
                            <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full font-bold">Afastado</span>
                        </div>
                        ${p.observacao ? `<div class="mt-2 text-xs text-slate-500 border-t border-slate-100 pt-2"><i class="fa-regular fa-clock mr-1"></i> ${p.observacao}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        function openLeaveModal() {
            const modal = document.getElementById('leave-modal');
            const searchInput = document.getElementById('leave-search-input');
            
            // Clear search on open
            if(searchInput) searchInput.value = '';
            
            // Initial render
            renderLeaveList('');

            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.querySelector('#leave-modal > div').classList.add('scale-100'); }, 10);
        }

        function closeLeaveModal() {
            const modal = document.getElementById('leave-modal');
            modal.classList.add('opacity-0');
            document.querySelector('#leave-modal > div').classList.remove('scale-100');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- Other Logic (Same as before) ---
        
        async function saveData(item) {
             // ... save logic handled in handleFileUpload and saveEdit
        }

        function populateFilters() {
            const fill = (id, key) => {
                const sel = document.getElementById(id);
                if(!sel) return;
                const opts = [...new Set(currentData.map(d => d[key]).filter(v => v))].sort();
                const curr = sel.value;
                sel.innerHTML = `<option value="">Todos</option>` + opts.map(o => `<option value="${o}">${o}</option>`).join('');
                if(opts.includes(curr)) sel.value = curr;
            };
            fill('filter-lotacao', 'lotacao');
            fill('filter-cargo', 'cargo');
            fill('filter-vinculo', 'vinculo');
        }

        function applyFilters() {
            const term = document.getElementById('search-input')?.value.toLowerCase() || '';
            const fLot = document.getElementById('filter-lotacao')?.value || '';
            const fCar = document.getElementById('filter-cargo')?.value || '';
            const fVin = document.getElementById('filter-vinculo')?.value || '';

            // Check if search term is a "leave" keyword
            const isLicencaQuery = ['licença', 'licenca', 'afastado', 'afastada', 'afastados'].some(k => term.includes(k));

            const filtered = currentData.filter(p => {
                const hasLicenca = p.licenca && p.licenca.trim().length > 0;
                let matchesText = !term || (p.nome && p.nome.toLowerCase().includes(term)) || (p.lotacao && p.lotacao.toLowerCase().includes(term));
                if(isLicencaQuery && hasLicenca) { matchesText = true; }

                return matchesText && (!fLot || p.lotacao === fLot) && (!fCar || p.cargo === fCar) && (!fVin || p.vinculo === fVin);
            });
            renderTable(filtered);
            updateDashboard(filtered); 
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            const empty = document.getElementById('empty-state');
            const countLbl = document.getElementById('showing-count');
            const totalLbl = document.getElementById('db-count-badge');
            
            if(totalLbl) totalLbl.innerText = currentData.length;
            if(countLbl) countLbl.innerText = `Mostrando ${data.length}`;
            
            if(data.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');
            
            tbody.innerHTML = data.slice(0, 500).map(p => {
                const isLicenca = p.licenca && p.licenca.length > 2;
                const statusHtml = isLicenca 
                           ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-amber-100 text-amber-700">Afastado</span>' 
                           : '<span class="px-2 py-0.5 rounded text-xs font-bold bg-emerald-100 text-emerald-700">Ativo</span>';
                           
                // Name color logic: Red if on leave, Slate if active
                const nameClass = isLicenca ? "text-red-600 font-bold" : "text-slate-700 font-semibold";

                return `
                <tr class="hover:bg-blue-50 transition border-b border-slate-100 last:border-0 group">
                    <td class="p-3 ${nameClass} align-top">${p.nome || '-'}</td>
                    <td class="p-3 text-slate-600 align-top">${p.lotacao || '-'}</td>
                    <td class="p-3 text-slate-600 align-top">${p.cargo || '-'}</td>
                    <td class="p-3 text-slate-600 align-top whitespace-nowrap">${p.vinculo || '-'}</td>
                    <td class="p-3 text-slate-600 align-top whitespace-nowrap">${p.turno || '-'}</td>
                    <td class="p-3 align-top whitespace-nowrap">
                         ${statusHtml}
                    </td>
                     <td class="p-3 text-slate-500 align-top text-xs min-w-[150px]">${p.observacao || ''}</td>
                    <td class="p-3 text-center align-top">
                        <div class="flex justify-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition">
                            <button onclick="openEditModal('${p.id}')" class="p-1 hover:scale-110" title="Editar"><img src="https://i.ibb.co/bMMd5SHG/pen.png" class="w-4 h-4"></button>
                            <button onclick="confirmDelete('${p.id}')" class="p-1 hover:scale-110" title="Excluir"><img src="https://i.ibb.co/VcqWYhfJ/deelte.png" class="w-4 h-4"></button>
                        </div>
                    </td>
                </tr>
            `}).join('');
            
            updateDynamicStats(data);
        }
        
        function updateDynamicStats(data) {
             const container = document.getElementById('dynamic-stats-container');
             if(!container) return;
             
             const totalDB = currentData.length || 1; 
             const currentCount = data.length;
             const percentage = ((currentCount / totalDB) * 100).toFixed(1);
             const label = document.getElementById('filter-lotacao')?.value || "Visão Geral";
             const afastadosCount = data.filter(p => p.licenca && p.licenca.trim().length > 2).length;
             const afastadosPct = currentCount > 0 ? ((afastadosCount / currentCount) * 100).toFixed(1) : 0;
             const vCounts = {};
             data.forEach(p => { const v = p.vinculo || 'NÃO INFORMADO'; vCounts[v] = (vCounts[v] || 0) + 1; });
             
             let html = `
                <div class="bg-white p-3 rounded shadow-sm flex-col justify-between h-20 min-w-[200px] border-l-4 border-blue-500 inline-flex align-top mr-2 mb-2">
                    <div class="flex justify-between items-end mb-2 w-full">
                        <div><span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">Filtro Ativo</span><h3 class="text-sm font-bold text-slate-700 truncate block w-24" title="${label}">${label}</h3></div>
                        <div class="text-right"><span class="text-xl font-bold text-blue-600 block">${percentage}%</span></div>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden"><div class="bg-blue-500 h-1.5 rounded-full" style="width: ${percentage}%"></div></div>
                </div>

                <!-- NEW AFASTADOS CARD -->
                <div class="bg-white p-3 rounded shadow-sm flex-col justify-between h-20 min-w-[180px] border-l-4 border-amber-500 inline-flex align-top mr-2 mb-2">
                     <div class="flex justify-between items-end mb-2 w-full">
                        <div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">Em Licença</span>
                            <div class="flex items-baseline">
                                <h3 class="text-lg font-bold text-slate-700 mr-1">${afastadosCount}</h3>
                            </div>
                        </div>
                        <div class="text-right"><span class="text-lg font-bold text-amber-600 block">${afastadosPct}%</span></div>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden"><div class="bg-amber-500 h-1.5 rounded-full" style="width: ${afastadosPct}%"></div></div>
                </div>

                <div class="bg-slate-800 text-white p-3 rounded shadow-sm inline-flex flex-col justify-between h-20 min-w-[140px] align-top mr-2 mb-2">
                    <p class="text-[10px] uppercase font-bold opacity-70">Listados</p>
                    <div class="flex justify-between items-end"><p class="text-2xl font-bold leading-none">${currentCount}</p><i class="fa-solid fa-filter opacity-50"></i></div>
                </div>
             `;
             
             Object.entries(vCounts).sort((a,b)=>b[1]-a[1]).forEach(([k, c]) => {
                html += `<div class="${getVinculoColor(k)} border p-3 rounded shadow-sm inline-flex flex-col justify-between h-20 min-w-[140px] align-top mr-2 mb-2">
                        <p class="text-[10px] uppercase font-bold opacity-80 truncate w-24" title="${k}">${k}</p>
                        <div class="flex justify-between items-end"><p class="text-2xl font-bold leading-none">${c}</p><i class="fa-solid fa-users opacity-40"></i></div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        async function confirmDelete(id) {
            if(!confirm("Excluir registro?")) return;
            try {
                if(useFirebase) await deleteDoc(doc(db, 'servidores', String(id)));
                else {
                    const idb = await openIDB();
                    const tx = idb.transaction('personnel', 'readwrite');
                    tx.objectStore('personnel').delete(parseInt(id));
                }
                currentData = currentData.filter(p => p.id != id);
                applyFilters();
                showToast("Excluído.", "info");
            } catch(e) { console.error(e); showToast("Erro ao excluir.", "error"); }
        }

        function openEditModal(id) {
            const rec = currentData.find(p => p.id == id);
            if(!rec) return;
            document.getElementById('edit-id').value = id;
            ['nome','lotacao','cargo','funcao','vinculo','turno','licenca','observacao'].forEach(k => {
                document.getElementById('edit-'+k).value = rec[k] || '';
            });
            const m = document.getElementById('edit-modal');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); document.getElementById('edit-modal-panel').classList.add('scale-100'); }, 10);
        }

        function closeEditModal() {
            const m = document.getElementById('edit-modal');
            m.classList.add('opacity-0');
            document.getElementById('edit-modal-panel').classList.remove('scale-100');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        async function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const updated = {};
            ['nome','lotacao','cargo','funcao','vinculo','turno','licenca','observacao'].forEach(k => {
                updated[k] = document.getElementById('edit-'+k).value;
            });

            try {
                if(useFirebase) await updateDoc(doc(db, 'servidores', String(id)), updated);
                else {
                    const idb = await openIDB();
                    const tx = idb.transaction('personnel', 'readwrite');
                    const rec = currentData.find(p => p.id == id);
                    if(rec) {
                        const newRec = { ...rec, ...updated };
                        if(typeof rec.id === 'number') newRec.id = rec.id; 
                        tx.objectStore('personnel').put(newRec);
                    }
                }
                const idx = currentData.findIndex(p => p.id == id);
                if(idx !== -1) currentData[idx] = { ...currentData[idx], ...updated };
                closeEditModal();
                applyFilters();
                showToast("Salvo!", "success");
            } catch(e) { console.error(e); showToast("Erro ao salvar.", "error"); }
        }
        
        async function resetData() {
            if(!confirm("Apagar TUDO?")) return;
            if(useFirebase) {
                const snap = await getDocs(collection(db, 'servidores'));
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
            } else {
                const idb = await openIDB();
                const tx = idb.transaction('personnel', 'readwrite');
                tx.objectStore('personnel').clear();
            }
            currentData = [];
            applyFilters();
            showToast("Banco limpo.", "info");
        }

        // --- Upload ---
        const fileInput = document.getElementById('file-upload');
        if(fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const r = new FileReader();
                r.onload = async (evt) => {
                    const lines = evt.target.result.split(/\r\n|\n/);
                    const newData = [];
                    lines.forEach(line => {
                         // Simple parse logic reuse
                         let separator = ';';
                         if(line.includes('\t')) separator = '\t';
                         const cols = line.split(separator);
                         if(cols.length > 2 && !cols[1].includes('NOME') && cols[1].trim() !== '') {
                             newData.push({
                                 lotacao: categorizeUnit(cols[0]?.trim()),
                                 nome: cols[1]?.trim(),
                                 cargo: cols[3]?.trim(),
                                 vinculo: cols[5]?.trim(),
                                 licenca: cols[7]?.trim(),
                                 observacao: cols[9]?.trim()
                             });
                         }
                    });

                    if (useFirebase) {
                        const batch = writeBatch(db);
                        let counter = 0;
                        for(const item of newData) {
                            const ref = doc(collection(db, 'servidores'));
                            batch.set(ref, item);
                            counter++;
                            if(counter >= 400) { await batch.commit(); counter = 0; }
                        }
                        if(counter > 0) await batch.commit();
                    } else {
                         const idb = await openIDB();
                         const tx = idb.transaction('personnel', 'readwrite');
                         const store = tx.objectStore('personnel');
                         newData.forEach(item => store.add(item));
                    }
                    
                    await loadData();
                    showToast(`${newData.length} importados.`);
                    switchTab('dashboard');
                };
                r.readAsText(file, 'UTF-8');
            });
        }

        // --- Helpers ---
        function updateDashboard(filtered = currentData) {
            const total = filtered.length;
            const licencas = filtered.filter(p => p.licenca && p.licenca.trim().length > 2).length;
            const locais = new Set(filtered.map(p => p.lotacao)).size;
            const cargos = new Set(filtered.map(p => p.cargo)).size;
            
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-licenca').innerText = licencas;
            document.getElementById('stat-locais').innerText = locais;
            document.getElementById('stat-cargos').innerText = cargos;
            
            renderCharts();
        }

        function renderCharts() {
            if(typeof Chart === 'undefined') return;
            const countBy = (k) => {
                const map = {};
                currentData.forEach(p => { const v = p[k] || 'N/A'; map[v] = (map[v] || 0) + 1; });
                return Object.entries(map).sort((a,b)=>b[1]-a[1]);
            };
            
            const byUnit = countBy('lotacao');
            const byRole = countBy('cargo');
            const top5 = byUnit.slice(0, 5);
            
            if(charts.pie) charts.pie.destroy();
            if(charts.bar1) charts.bar1.destroy();
            if(charts.bar2) charts.bar2.destroy();
            if(charts.top15) charts.top15.destroy();
            
            const ctxPie = document.getElementById('chart-pie');
            if(ctxPie) {
                charts.pie = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: { labels: top5.map(d=>d[0]), datasets: [{ data: top5.map(d=>d[1]), backgroundColor: ['#3b82f6','#0f172a','#64748b','#94a3b8','#cbd5e1'] }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
                });
            }
            
            const ctxUnits = document.getElementById('chart-units');
            if(ctxUnits) {
                const top10 = byUnit.slice(0,10);
                charts.bar1 = new Chart(ctxUnits, {
                    type: 'bar',
                    data: { labels: top10.map(d=>d[0]), datasets: [{ label: 'Servidores', data: top10.map(d=>d[1]), backgroundColor: '#3b82f6', borderRadius: 4 }] },
                    options: { maintainAspectRatio: false, indexAxis: 'y', scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            }

            const ctxRoles = document.getElementById('chart-roles');
            if(ctxRoles) {
                const top10R = byRole.slice(0,10);
                charts.bar2 = new Chart(ctxRoles, {
                    type: 'bar',
                    data: { labels: top10R.map(d=>d[0]), datasets: [{ label: 'Ocupantes', data: top10R.map(d=>d[1]), backgroundColor: '#0f172a', borderRadius: 4 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            }
            
            renderTop15Chart('TOTAL');
        }
        
        function renderTop15Chart(filter) {
            const ctx = document.getElementById('chart-top15');
            if(!ctx) return;
            if(charts.top15) charts.top15.destroy();
            
            let data = currentData;
            if(filter !== 'TOTAL') data = currentData.filter(p => p.vinculo && p.vinculo.includes(filter));
            
            const map = {};
            data.forEach(p => { const v = p.lotacao || 'N/A'; map[v] = (map[v] || 0) + 1; });
            const top15 = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,15);
            
            charts.top15 = new Chart(ctx, {
                type: 'bar',
                data: { labels: top15.map(d=>d[0]), datasets: [{ label: 'Qtd', data: top15.map(d=>d[1]), backgroundColor: '#2563eb', borderRadius: 4 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function setupListeners() {
             ['search-input', 'filter-lotacao', 'filter-cargo', 'filter-vinculo'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', applyFilters);
             });
             document.getElementById('chart-top15-filter')?.addEventListener('change', (e) => renderTop15Chart(e.target.value));
             
             // Leave Search Listener
             document.getElementById('leave-search-input')?.addEventListener('input', (e) => {
                 renderLeaveList(e.target.value);
             });
        }
        
        function exportToExcel() { showToast("Gerando Excel..."); /* SheetJS Logic */ }
        function exportToPrint() { window.print(); }

    </script>
</body>
</html>